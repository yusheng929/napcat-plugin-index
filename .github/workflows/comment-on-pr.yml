name: 校验结果评论 & 自动标签

# 此工作流在 "插件 PR 自动审核" 完成后触发
# 使用 workflow_run 事件，在 base 仓库上下文中运行，拥有写权限
# 解决 fork PR 中 GITHUB_TOKEN 无法发表评论的 403 问题

on:
  workflow_run:
    workflows: ["插件 PR 自动审核"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  comment:
    name: 发表校验结果评论
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Download validation result artifact
        uses: actions/download-artifact@v4
        with:
          name: validation-result
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        id: download-result

      - name: Download PR metadata artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        id: download-metadata

      - name: Post PR comment
        if: steps.download-result.outcome == 'success' && steps.download-metadata.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // 读取 PR 编号和退出码
            const prNumber = parseInt(fs.readFileSync('pr-number.txt', 'utf-8').trim(), 10);
            const exitCode = fs.readFileSync('exit-code.txt', 'utf-8').trim();

            if (!prNumber || isNaN(prNumber)) {
              console.log('无法获取 PR 编号，跳过评论');
              return;
            }

            // 读取校验输出
            let output = '';
            try {
              output = fs.readFileSync('validation-output.txt', 'utf-8');
            } catch {
              output = '（无法读取校验输出）';
            }

            // 清理 ANSI 颜色码
            const clean = output.replace(/\x1b\[[0-9;]*m/g, '');

            const passed = exitCode === '0';
            const icon = passed ? '✅' : '❌';
            const title = passed ? '插件校验通过' : '插件校验未通过';

            const body = [
              `## ${icon} ${title}`,
              '',
              '<details>',
              '<summary>校验详情（点击展开）</summary>',
              '',
              '```',
              clean,
              '```',
              '',
              '</details>',
              '',
              passed
                ? '> 所有检查已通过，等待维护者审核合并。'
                : [
                    '> **请修复上述错误后重新提交。** 常见问题：',
                    '> - 插件 ID 必须符合 `napcat-plugin-xxx` 格式',
                    '> - 所有必填字段不能为空',
                    '> - downloadUrl 必须是可访问的 .zip 链接',
                    '> - 版本号需符合 semver 格式',
                  ].join('\n'),
            ].join('\n');

            // 查找已有的 bot 评论
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('插件校验')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
              console.log(`已更新评论 #${botComment.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
              console.log(`已在 PR #${prNumber} 发表新评论`);
            }

  auto-label:
    name: 自动打标签
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Download PR metadata artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: /tmp/pr-metadata
        continue-on-error: true
        id: download-metadata

      - name: Read PR number
        if: steps.download-metadata.outcome == 'success'
        id: pr-info
        run: echo "pr_number=$(cat /tmp/pr-metadata/pr-number.txt)" >> $GITHUB_OUTPUT

      - name: Detect change type and label
        if: steps.download-metadata.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr-info.outputs.pr_number }}', 10);
            if (!prNumber || isNaN(prNumber)) {
              console.log('无法获取 PR 编号，跳过标签');
              return;
            }

            // 通过 GitHub API 获取 base 分支和 PR 分支的 plugins.v4.json
            async function getFileContent(ref) {
              const { data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'plugins.v4.json',
                ref: ref,
              });
              return JSON.parse(Buffer.from(data.content, 'base64').toString('utf-8'));
            }

            // 获取 PR 信息以得到 head SHA
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            let baseContent, currentContent;
            try {
              baseContent = await getFileContent(pr.base.sha);
              currentContent = await getFileContent(pr.head.sha);
            } catch (e) {
              console.log('无法获取 plugins.v4.json:', e.message);
              return;
            }

            const baseIds = new Set(baseContent.plugins.map(p => p.id));
            const currentIds = new Set(currentContent.plugins.map(p => p.id));

            const labels = [];

            // 新增插件
            for (const p of currentContent.plugins) {
              if (!baseIds.has(p.id)) labels.push('新插件');
            }

            // 更新插件
            for (const p of currentContent.plugins) {
              if (baseIds.has(p.id)) {
                const base = baseContent.plugins.find(b => b.id === p.id);
                if (JSON.stringify(base) !== JSON.stringify(p)) {
                  labels.push('插件更新');
                }
              }
            }

            // 删除插件
            for (const id of baseIds) {
              if (!currentIds.has(id)) labels.push('插件删除');
            }

            const uniqueLabels = [...new Set(labels)];
            if (uniqueLabels.length > 0) {
              // 确保标签存在
              for (const label of uniqueLabels) {
                try {
                  await github.rest.issues.getLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                  });
                } catch {
                  const colors = { '新插件': '0e8a16', '插件更新': '1d76db', '插件删除': 'e11d48' };
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: colors[label] || 'ededed',
                  });
                }
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: uniqueLabels,
              });

              console.log(`已为 PR #${prNumber} 添加标签: ${uniqueLabels.join(', ')}`);
            }
